<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>族語程度自我評估程式</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(to right, #e0f7fa, #fff3e0);
      color: #1f2937;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 100%;
      max-width: 48rem;
      margin: 0 auto;
    }
    .btn {
      padding: 0.5rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
    }
    .btn:hover {
      transform: scale(1.05);
    }
    .btn-primary {
      background: linear-gradient(to right, #3b82f6, #4f46e5);
      color: white;
    }
    .btn-secondary {
      background: linear-gradient(to right, #d1d5db, #9ca3af);
      color: #1f2937;
    }
    .btn-success {
      background: linear-gradient(to right, #10b981, #047857);
      color: white;
    }
    .progress-bar-container {
      width: 100%;
      background-color: #d1d5db;
      border-radius: 9999px;
      height: 0.5rem;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, #60a5fa, #6366f1);
      border-radius: 9999px;
      transition: width 0.3s ease-in-out;
    }
    .rating-slider-wrapper {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 2.5rem;
    }
    .rating-btn {
      flex: 1 1 30%;
      min-width: 8rem;
      padding: 1rem;
      background-color: #e5e7eb;
      border-radius: 1rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .rating-btn:hover {
      background-color: #c7d2fe;
    }
    .rating-btn.selected {
      background-color: #6366f1;
      color: white;
    }
    .indicator {
      font-size: 0.875rem;
      color: #4b5563;
      margin-top: 0.5rem;
      text-align: center;
    }
    .ability-tags {
      font-size: 0.875rem;
      margin-top: 0.5rem;
      color: #6b7280;
      text-align: center;
    }
    /* Custom Modal styles for error messages */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 1rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        text-align: center;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4">
  <div id="app" class="w-full space-y-8">
    <section id="welcome-screen" class="card text-center space-y-4">
      <h1 class="text-3xl font-bold text-indigo-700">族語程度自我評估程式</h1>
      <p class="text-gray-700">透過評估聽說讀寫能力，瞭解您的通用族語程度。</p>
      <button id="start-test-btn" class="btn btn-primary">開始評估</button>
    </section>

    <section id="test-screen" class="card hidden space-y-6">
      <!-- 新增大標題 -->
      <h1 class="text-3xl font-bold text-indigo-700 text-center mb-6">族語程度自我評估程式</h1>
      <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar w-0"></div>
      </div>
      <div id="question-number" class="text-right text-sm text-gray-600"></div>
      <div id="question-container"></div>
      <div class="rating-slider-wrapper">
        <div class="rating-btn" data-score="1">完全不符合</div>
        <div class="rating-btn" data-score="4">部分符合</div>
        <div class="rating-btn" data-score="7">完全符合</div>
      </div>
      <div id="button-controls" class="flex justify-between items-center mt-10">
        <button id="prev-question-btn" class="btn btn-secondary hidden">上一題</button>
        <button id="next-question-btn" class="btn btn-primary">下一題</button>
        <button id="submit-test-btn" class="btn btn-success hidden">提交評估</button>
      </div>
    </section>

    <section id="result-screen" class="card hidden space-y-4 text-center">
      <h2 class="text-2xl font-bold text-green-600">評估結果</h2>
      <p class="text-xl font-medium" id="proficiency-description"></p>
      <p id="proficiency-level" class="text-4xl font-extrabold text-indigo-700"></p>
      <button id="retake-test-btn" class="btn btn-primary">重新評估</button>
    </section>
  </div>

  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <p id="modalMessage"></p>
      <button id="modalOkButton" class="btn btn-primary mt-4">確定</button>
    </div>
  </div>

  <script>
    let questions = [];
    let indicators = [];
    let scores = [];
    let current = 0;

    const levelOrder = ['初級', '中級', '中高級', '高級', '優級'];

    function showMessage(message) {
        const modal = document.getElementById("messageModal");
        const modalMessage = document.getElementById("modalMessage");
        modalMessage.innerText = message;
        modal.style.display = "flex"; 

        const closeButton = document.querySelector(".close-button");
        const okButton = document.getElementById("modalOkButton");

        const hideModal = () => {
            modal.style.display = "none";
            closeButton.onclick = null;
            okButton.onclick = null;
            window.onclick = null; 
        };

        closeButton.onclick = hideModal;
        okButton.onclick = hideModal;

        window.onclick = (event) => {
            if (event.target == modal) {
                hideModal();
            }
        };
    }

    async function fetchQuestions() {
      try {
        const res = await fetch("https://raw.githubusercontent.com/ss1111119/indigenous-language-self-assessment/main/abilityIndicatorsData.json");
        if (!res.ok) {
            throw new Error(`HTTP 錯誤：${res.status}`);
        }
        const rawData = await res.json(); 

        let transformedIndicators = [];
        for (const skillType in rawData) {
            if (rawData.hasOwnProperty(skillType)) {
                const levels = rawData[skillType];
                for (const level in levels) {
                    if (levels.hasOwnProperty(level) && Array.isArray(levels[level])) {
                        levels[level].forEach(questionText => {
                            transformedIndicators.push({
                                question: questionText,
                                description: questionText, 
                                skillType: skillType,
                                level: level
                            });
                        });
                    }
                }
            }
        }
        
        indicators = transformedIndicators; 

        questions = indicators.map(i => i.question); 

        if (indicators.length > 0) {
          showQuestion();
        } else {
          showMessage("未取得有效資料，請檢查資料來源。");
        }
      } catch (err) {
        console.error("無法載入資料:", err);
        showMessage(`無法載入資料，請檢查網路連線、資料來源 URL 或資料格式。\n錯誤訊息: ${err.message}`);
      }
    }

    function showQuestion() {
      if (!indicators[current]) return;

      const questionEl = document.getElementById("question-container");
      const q = indicators[current]; 

      // 註解掉這行，以關閉「第 X 題 / 共 Y 題」的顯示
      // document.getElementById("question-number").innerText = `第 ${current + 1} 題 / 共 ${questions.length} 題`;
      questionEl.innerHTML = `
        <p class="text-lg font-semibold">${q.question}</p>
      `;

      document.querySelectorAll(".rating-btn").forEach(btn => {
        btn.classList.remove("selected"); 
        if (parseInt(btn.dataset.score) === scores[current]) {
          btn.classList.add("selected");
        }
      });

      document.getElementById("progress-bar").style.width = `${(current / questions.length) * 100}%`;
      
      const prevBtn = document.getElementById("prev-question-btn");
      const nextBtn = document.getElementById("next-question-btn");
      const submitBtn = document.getElementById("submit-test-btn");
      const buttonControls = document.getElementById("button-controls"); 

      prevBtn.classList.toggle("hidden", current === 0);
      
      if (current === 0) {
          buttonControls.classList.remove("justify-between");
          buttonControls.classList.add("justify-end"); 
      } else {
          buttonControls.classList.remove("justify-end");
          buttonControls.classList.add("justify-between"); 
      }

      nextBtn.classList.toggle("hidden", current === questions.length - 1);
      submitBtn.classList.toggle("hidden", current !== questions.length - 1);
    }

    document.getElementById("start-test-btn").onclick = () => {
      document.getElementById("welcome-screen").classList.add("hidden"); 
      document.getElementById("test-screen").classList.remove("hidden"); 
      fetchQuestions(); 
    };

    document.querySelectorAll(".rating-btn").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".rating-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected"); 
        scores[current] = parseInt(btn.dataset.score); 
      };
    });

    document.getElementById("next-question-btn").onclick = () => {
      if (scores[current] == null) {
        return showMessage("請先選擇答案");
      }

      const currentQuestion = indicators[current];
      const currentLevel = currentQuestion.level;
      const currentScore = scores[current];

      if (currentScore === 7 && levelOrder.includes(currentLevel)) {
        const currentLevelIndex = levelOrder.indexOf(currentLevel);
        const nextHigherLevelIndex = currentLevelIndex + 1;

        if (nextHigherLevelIndex < levelOrder.length) {
          const targetLevel = levelOrder[nextHigherLevelIndex];
          let nextIndex = -1;

          for (let i = current + 1; i < indicators.length; i++) {
            const questionLevel = indicators[i].level;
            const questionLevelIndex = levelOrder.indexOf(questionLevel);

            if (questionLevelIndex >= nextHigherLevelIndex) {
              nextIndex = i;
              break;
            }
          }
          
          if (nextIndex !== -1) {
            current = nextIndex;
          } else {
            current++;
          }
        } else {
          current++;
        }
      } else {
        current++;
      }
      
      if (current >= questions.length) {
          current = questions.length - 1; 
          document.getElementById("next-question-btn").classList.add("hidden"); 
          document.getElementById("submit-test-btn").classList.remove("hidden"); 
      }

      showQuestion(); 
    };

    document.getElementById("prev-question-btn").onclick = () => {
      current--; 
      showQuestion(); 
    };

    document.getElementById("submit-test-btn").onclick = () => {
      if (scores[current] == null) {
          return showMessage("請先選擇答案，才能提交評估。"); 
      }
      
      const answeredScores = scores.filter(score => score != null);

      let avg = 0;
      if (answeredScores.length > 0) {
          const totalScore = answeredScores.reduce((sum, score) => sum + score, 0);
          avg = totalScore / answeredScores.length;
      } else {
          avg = 0;
      }
      
      document.getElementById("test-screen").classList.add("hidden"); 
      document.getElementById("result-screen").classList.remove("hidden"); 
      
      let proficiencyLevelText = "";
      let proficiencyDescription = "";

      if (avg >= 6.5) { 
        proficiencyLevelText = "優級";
        proficiencyDescription = "您已具備優異的族語能力，能流暢且精準地理解和表達各種複雜主題。";
      } else if (avg >= 5.5) { 
        proficiencyLevelText = "高級";
        proficiencyDescription = "您具備高級族語能力，能深入理解並有條理地表達廣泛主題。";
      } else if (avg >= 4.5) { 
        proficiencyLevelText = "中高級";
        proficiencyDescription = "您已達到中高級族語程度，能應對日常和部分專業情境的溝通。";
      } else if (avg >= 2.5) { 
        proficiencyLevelText = "中級";
        proficiencyDescription = "您已具備中級族語能力，能理解並表達日常生活中的一般語句。";
      } else { 
        proficiencyLevelText = "初級";
        proficiencyDescription = "您已具備初級族語能力，能理解並使用簡單的日常詞語和語句。";
      }

      document.getElementById("proficiency-level").innerText = proficiencyLevelText; 
      document.getElementById("proficiency-description").innerText = proficiencyDescription; 
    };

    document.getElementById("retake-test-btn").onclick = () => location.reload();
  </script>
</body>
</html>
